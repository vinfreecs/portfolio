---
const { project } = Astro.props;
const id = `dlg-${project.slug || project.name.replace(/\s+/g, "-").toLowerCase()}`;
---

<!-- CARD -->
<div
  class="bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl p-4 md:p-5 transition cursor-pointer"
  onclick={`openDialog('${id}')`}
  role="button" tabindex="0"
  onkeydown={`(event.key==='Enter'||event.key===' ')&&openDialog('${id}')`}
>
  <div class="flex items-start justify-between gap-3">
    <div>
      <h3 class="text-lg font-semibold">{project.name}</h3>
      {project.tech?.length ? <p class="text-sm text-gray-300">{project.tech.join(", ")}</p> : null}
      {project.summary ? <p class="text-sm text-gray-400 mt-1">{project.summary}</p> : null}
    </div>
  </div>
</div>

<!-- Put the dialog OUTSIDE the clickable card (as a sibling) -->
<dialog
  id={id}
  class="inset-0 mx-auto my-auto max-w-3xl w-[92%] rounded-xl p-0 bg-gray-900 text-gray-100 border border-white/10 shadow-2xl"
>
  <form method="dialog" class="contents">
    <div class="px-5 py-4 border-b border-white/10 flex items-center justify-between gap-3">
      <h4 class="text-xl font-semibold truncate">{project.name}</h4>

      <div class="flex items-center gap-3">
        {project.url && (
          <a
            href={project.url}
            target="_blank"
            rel="noopener noreferrer"
            aria-label="View on GitHub"
            class="hover:text-gray-300"
          >
            <!-- GitHub icon -->
            <svg viewBox="0 0 24 24" class="w-6 h-6 fill-current" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd"
                d="M12 2C6.48 2 2 6.58 2 12.18c0 4.49 2.87 8.29 6.86 9.63.5.09.68-.22.68-.48
                0-.24-.01-.87-.01-1.7-2.79.62-3.38-1.36-3.38-1.36-.46-1.19-1.12-1.5-1.12-1.5
                -.91-.63.07-.62.07-.62 1 .07 1.53 1.05 1.53 1.05 .9 1.57 2.36 1.12 2.93.86
                .09-.67.35-1.12.63-1.38-2.23-.26-4.58-1.14-4.58-5.09 0-1.12.39-2.03 1.03-2.75
                -.1-.26-.45-1.32.1-2.75 0 0 .84-.27 2.76 1.05a9.22 9.22 0 0 1 5.02 0c1.92-1.32
                2.76-1.05 2.76-1.05.55 1.43.2 2.49.1 2.75.64.72 1.03 1.63 1.03 2.75 0 3.95-2.36
                4.82-4.6 5.08.36.32.68.95.68 1.92 0 1.38-.01 2.49-.01 2.83 0 .26.18.58.69.48
                A10.19 10.19 0 0 0 22 12.18C22 6.58 17.52 2 12 2z" />
            </svg>
          </a>
        )}
        <button
          type="button"
          class="text-sm px-3 py-1 rounded-md border border-white/20 hover:bg-white/10"
          onclick={`document.getElementById('${id}').close()`}
        >
          Close
        </button>
      </div>
    </div>

    <div class="px-5 pb-5 pt-3">
      {project.summary ? <p class="text-gray-300">{project.summary}</p> : null}

      <div class="mt-4 grid md:grid-cols-2 gap-4 w-full">
        {project.media?.map((m, idx) => {
          const src = m.src || "";
          const ext = src.split(".").pop()?.toLowerCase();
          return (
            <div key={idx} class="w-full aspect-video overflow-hidden rounded-lg">
              {["mp4","webm"].includes(ext) ? (
                <video
                  src={src}
                  autoplay
                  muted
                  loop
                  playsinline
                  class="w-full h-full object-cover"
                />
              ) : (
                <img src={src} alt={`${project.name} media ${idx+1}`} class="w-full h-full object-cover" />
              )}
            </div>
          );
        })}
      </div>
    </div>
  </form>
</dialog>

<style is:global>
  /* Backdrop fade (optional) */
  dialog::backdrop { background: rgba(0,0,0,0.6); }
</style>

<script is:inline>
  // Simple, reliable open()
  function openDialog(id) {
    const dlg = document.getElementById(id);
    if (dlg && typeof dlg.showModal === 'function') {
      dlg.showModal();
    } else {
      // Fallback if <dialog> not supported
      alert('Dialog API not supported in this browser.');
    }
  }
</script>
